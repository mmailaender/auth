@role(server)
function createSocialProviderAccount(firstName: String, lastName: String, email: String, image: String | Null, provider: "Github" | "Facebook" | "Passkey" | "Google", providerAccountId: String): Account {
  let user = User.firstWhere(.email == email)
  
  if(user == null) {
    let accountId = newId()
    let userId = newId()

    let account = Account.create({
      id: accountId,
      provider: provider,
      providerAccountId: providerAccountId,
      user: User.create({
        id: userId,
        firstName: firstName,
        lastName: lastName,
        email: email,
        emailVerified: Time.now(),
        accounts: [Account.byId(accountId)]
      })
    })
    
    if(image != null) {
      User.byId(userId)!.update({
        image: image
      })
    }
    
    account
  } else {
    let account = Account.firstWhere(.user == user && .provider == provider)

    let account = if(account == null) {
      let account = Account.create({
        provider: provider,
        providerAccountId: providerAccountId,
        user: user!
      })
      
      let accounts = if(user!.accounts != null) {
        user!.accounts!.append(account)
      } else {
        [account]
      }
    
      user!.update({
        accounts: accounts 
      })

      account
    } 

    account!
  }
}